import{_ as t,D as e,J as a,y as s,K as i,s as l,A as o,ac as n,x as u,o as r,c,w as d,i as m,a as f,d as h,b as p,t as _,f as b,g,p as x,M as y,a8 as k,q as D,H as C}from"./index-52dd6894.js";import{_ as w}from"./uni-forms-item.4e6b57d7.js";import{_ as v}from"./uni-file-picker.3f0146be.js";import{_ as j}from"./uni-data-picker.37409a89.js";import{_ as V}from"./uni-forms.9d63b157.js";import{E as P}from"./editor.3db7de24.js";import{v as R}from"./uni-cms-articles.a079bc39.js";import"./uni-load-more.5c08c1b9.js";import"./uni-easyinput.cff98e18.js";import"./uni-tooltip.36348de7.js";import"./uni-dateformat.611f3c3a.js";import"./uni-link.7568b248.js";function T(t){let e=t.match(/\[[^\[\]\(\)]*?]\([^\[\]\(\)]*\)/g),a=[];if(!e)return a.push({type:"text",value:t}),a;for(let s=0;s<e.length;s++){const i=e[s],[l,o,n]=i.match(/\[(.*)]\((.*)\)/),u=t.indexOf(i);0===s&&u>0&&a.push({type:"text",value:t.substring(0,u)}),a.push({type:"link",value:o,href:n});const r=e[s+1];if(!r)continue;const c=t.indexOf(r),d=u+i.length;a.push({type:"text",value:t.substring(d,c)})}return a}function E(t){var e;let a=[];for(const s of t.ops)if("string"!=typeof s.insert)if(s.insert.image){"unlockContent"===((null==(e=null==s?void 0:s.attributes)?void 0:e["data-custom"])??"").split("&").reduce(((t,e)=>{const[a,s]=e.split("=");return t[a]=s,t}),{}).type?a.push({insert:{unlockContent:!0}}):a.push(s)}else a.push(s);else{const t=T(s.insert);s.attributes&&s.attributes.backgroundColor&&(s.attributes.background=s.attributes.backgroundColor);for(const e of t)switch(e.type){default:case"text":a.push({attributes:s.attributes||{},insert:e.value});break;case"link":a.push({attributes:{...s.attributes||{},link:e.href},insert:e.value})}}return{ops:a}}const I=e.database();I.command;function O(t){let e={};for(let a in R)t.includes(a)&&(e[a]=R[a]);return e}const U=t({components:{EditorComponent:P},data(){let t={user_id:"",category_id:"",title:"",content:null,excerpt:"",article_status:0,is_sticky:null,is_essence:null,comment_status:null,thumbnail:"",publish_date:null};return{formDataId:"",formData:t,formOptions:{comment_status_localdata:[{value:0,text:"关闭"},{value:1,text:"开放"}]},rules:{...O(Object.keys(t))},formats:{},wordCount:null,thumbnailPreview:{}}},onReady(){this.$refs.form.setRules(this.rules)},onLoad(t){if(t.id){const e=t.id;this.formDataId=e,this.getDetail(e)}},methods:{getDetail(t){a({mask:!0}),I.collection("uni-cms-articles").doc(t).field("user_id,category_id,title,content,excerpt,article_status,is_sticky,is_essence,comment_status,thumbnail,publish_date").get().then((t=>{const e=t.result.data[0];e&&(this.formData=e,this.formData.thumbnail&&(this.thumbnailPreview={extname:"jpg",url:this.formData.thumbnail}),this.setContents())})).catch((t=>{s({content:t.message||"请求服务失败",showCancel:!1})})).finally((()=>{i()}))},onEditorReady(t){t&&(this.editorCtx=t,this.setContents())},setContents(){if(this.editorCtx&&this.formData.content){const t=this.formData.content;this.editorCtx.setContents({delta:t})}},submit(t){if(!this.formData.title)return i(),l({icon:"none",title:"文章标题必填"});this.$refs.form.validate().then((e=>{this.editorCtx.getContents({success:a=>{this.submitForm({...e,article_status:t,title:this.formData.title,content:E(a.delta),publish_date:this.formData.publish_date?this.formData.publish_date:Date.now()})}})})).catch((t=>{console.error(t)}))},submitForm(t){return a({mask:!0}),I.collection("uni-cms-articles").doc(this.formDataId).update(t).then((()=>{l({icon:"none",title:0===t.article_status?"保存成功":0===this.formData.article_status?"发布成功":"更新成功"});try{this.getOpenerEventChannel().emit("refreshData")}catch(e){}setTimeout((()=>{1===t.article_status&&o()}),500)})).catch((t=>{s({content:t.message||"请求服务失败",showCancel:!1})})).finally((()=>{i()}))},uploadSuccess(t){this.formData.thumbnail=t.tempFilePaths[0],this.thumbnailPreview={extname:"jpg",url:t.tempFilePaths[0]}},onTextChange(t){this.wordCount=t.detail},navigateBack(){n().length>1?o(-1):u({url:"/uni_modules/uni-cms/pages/article/list/list"})}}},[["render",function(t,e,a,s,i,l){const o=b(g("uni-icons"),C),n=x,u=m,P=y,R=k("editor-component"),T=b(g("uni-forms-item"),w),E=b(g("uni-file-picker"),v),I=b(g("uni-data-picker"),j),O=D,U=b(g("uni-forms"),V);return r(),c(u,{class:"uni-container"},{default:d((()=>[f(u,{class:"header"},{default:d((()=>[f(u,{class:"back"},{default:d((()=>[f(u,{onClick:l.navigateBack,style:{"margin-left":"15px",display:"flex","align-items":"center"}},{default:d((()=>[f(o,{type:"back",size:"24"}),f(n,null,{default:d((()=>[h("返回")])),_:1})])),_:1},8,["onClick"])])),_:1})])),_:1}),f(U,{ref:"form","label-width":90,model:i.formData,validateTrigger:"bind","err-show-type":"toast"},{default:d((()=>[f(u,{class:"edit-box"},{default:d((()=>[f(u,{class:"title"},{default:d((()=>[f(P,{class:"uni-input",modelValue:i.formData.title,"onUpdate:modelValue":e[0]||(e[0]=t=>i.formData.title=t),"auto-height":"",placeholder:"文章标题"},null,8,["modelValue"])])),_:1}),f(R,{onTextchange:l.onTextChange,onReady:l.onEditorReady},null,8,["onTextchange","onReady"]),f(u,{class:"settings"},{default:d((()=>[f(T,{name:"excerpt",label:"文章摘要"},{default:d((()=>[f(P,{class:"excerpt",placeholder:"文章摘要","auto-height":"",modelValue:i.formData.excerpt,"onUpdate:modelValue":e[1]||(e[1]=t=>i.formData.excerpt=t)},null,8,["modelValue"])])),_:1}),f(T,{name:"thumbnail",label:"封面",required:""},{default:d((()=>[f(E,{modelValue:i.thumbnailPreview,"onUpdate:modelValue":e[2]||(e[2]=t=>i.thumbnailPreview=t),"file-mediatype":"image",mode:"grid","file-extname":"png,jpg",limit:1,"return-type":"object","image-styles":{width:"150px",height:"150px"},onSuccess:l.uploadSuccess},null,8,["modelValue","onSuccess"]),f(u,{style:{color:"#999","font-size":"13px","margin-top":"10px"}},{default:d((()=>[f(n,null,{default:d((()=>[h("为了保证最佳效果展示；请上传16:9的封面图片")])),_:1})])),_:1})])),_:1}),f(T,{name:"user_id",label:"作者",required:""},{default:d((()=>[f(I,{modelValue:i.formData.user_id,"onUpdate:modelValue":e[3]||(e[3]=t=>i.formData.user_id=t),style:{width:"200px"},collection:"uni-id-users",where:"role=='uni-cms-author'",field:"nickname as text, _id as value"},null,8,["modelValue"])])),_:1}),f(T,{name:"category_id",label:"分类"},{default:d((()=>[f(I,{modelValue:i.formData.category_id,"onUpdate:modelValue":e[4]||(e[4]=t=>i.formData.category_id=t),style:{width:"200px"},collection:"uni-cms-categories",field:"name as text, _id as value"},null,8,["modelValue"])])),_:1})])),_:1}),f(u,{class:"uni-button-group m",style:{"padding-bottom":"50px"}},{default:d((()=>[0===i.formData.article_status?(r(),c(O,{key:0,class:"uni-button",style:{width:"100px","margin-right":"10px"},onClick:e[5]||(e[5]=t=>l.submit(0))},{default:d((()=>[h("保存")])),_:1})):p("",!0),f(O,{type:"primary",class:"uni-button",style:{width:"100px"},onClick:e[6]||(e[6]=t=>l.submit(1))},{default:d((()=>[h("更新")])),_:1})])),_:1})])),_:1})])),_:1},8,["model"]),f(u,{class:"footer"},{default:d((()=>[f(u,{class:"wrap"},{default:d((()=>[f(u,{class:"left"},{default:d((()=>[null!==i.wordCount?(r(),c(n,{key:0,class:"word-count"},{default:d((()=>[h("共 "+_(i.wordCount)+" 字",1)])),_:1})):p("",!0)])),_:1}),f(u,{class:"right"},{default:d((()=>[f(u,{class:"uni-button-group"},{default:d((()=>[0===i.formData.article_status?(r(),c(O,{key:0,class:"uni-button",style:{width:"100px","margin-right":"10px"},onClick:e[7]||(e[7]=t=>l.submit(0))},{default:d((()=>[h("保存")])),_:1})):p("",!0),f(O,{type:"primary",class:"uni-button",style:{width:"100px"},onClick:e[8]||(e[8]=t=>l.submit(1))},{default:d((()=>[h(_(0===i.formData.article_status?"发布":"更新"),1)])),_:1})])),_:1})])),_:1})])),_:1})])),_:1})])),_:1})}],["__scopeId","data-v-1b681d64"]]);export{U as default};
