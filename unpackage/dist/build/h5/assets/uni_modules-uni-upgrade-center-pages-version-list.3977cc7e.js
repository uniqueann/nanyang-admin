import{_ as e,E as t,v as a,S as i,n,a2 as s,K as l,o,c as d,w as r,i as p,a as u,d as c,t as h,e as f,r as g,F as m,z as _,a3 as y,f as b,g as w,a4 as x,J as v,H as A,y as I,h as C,j as k,k as L,u as T,l as N}from"./index.1c5e976d.js";import{_ as z}from"./uni-data-picker.d3a4411d.js";import{_ as D}from"./uni-dateformat.9c185026.js";import{_ as j}from"./uni-pagination.4b6fd0ad.js";import{_ as E}from"./unicloud-db.11caf7ca.js";import{a as M,e as V,d as $,b as S}from"./utils.391283b9.js";import"./uni-load-more.f55f2cfa.js";const O=t.database(),R=O.command,q=["name","title","stable_publish","type"];function U(e={}){return{create_env:R.neq("uni-stat"),...e}}const H=e({data:()=>({backButtonHover:!1,appVersionListDbName:M,currentAppid:"",currentAppName:"",query:"",where:"",orderby:"stable_publish desc,create_date desc",selectedIndexs:[],options:{pageSize:20,pageCurrent:1,...V},imageStyles:{width:64,height:64},loaded:!1,containerTop:{},appList:[],showAppIndex:0}),async onLoad({appid:e}){await this.getAppList(),this.appList.length?(this.loaded=!0,this.appList.forEach(((t,a)=>{(t.appid===e||$)&&(this.showAppIndex=a)})),this.setAppInfo(this.showAppIndex),this.where=U({appid:this.currentAppid})):this.showModalToAppManager()},computed:{...a("app",["appid"]),appNameList(){return this.appList.map((e=>e.name))}},watch:{showAppIndex(e){this.setAppInfo(e),this.where=U({appid:this.currentAppid})}},onReady(){this.containerTop.height=`${document.documentElement?document.documentElement.clientHeight:window.innerHeight}px`},methods:{setAppInfo(e){this.currentAppid=this.appList[e].appid,this.currentAppName=this.appList[e].name},navigateBack(){i()},getWhere(){const e=this.query.trim();if(!e)return"";const t=new RegExp(e,"i");return q.map((e=>t+".test("+e+")")).join(" || ")},search(){const e=this.getWhere(),t=e===this.where;this.where=e,this.where&&(this.where=`(${this.where}) && `),this.where+=`${new RegExp(this.currentAppid,"i")}.test(appid)`,t&&this.loadData()},loadData(e=!0){this.$refs.udb.loadData({clear:e})},onPageChanged(e){this.$refs.udb.loadData({current:e.current})},navigateTo(e,t){n({url:e,events:{refreshData:()=>{this.loadData(t)}}})},selectedItems(){var e=this.$refs.udb.dataList;return this.selectedIndexs.map((t=>e[t]._id))},delTable(){this.$refs.udb.remove(this.selectedItems())},selectionChange(e){this.selectedIndexs=e.detail.index},confirmDelete(e){this.$refs.udb.remove(e)},publish(e){const{top:t,left:a,width:i,height:n}=document.querySelector(".uni-button.publish").getBoundingClientRect(),l=Object.keys(this.options.type_valuetotext);s({itemList:Object.values(this.options.type_valuetotext),popover:{top:t+n,left:a,width:i},success:async e=>{this.navigateTo(`./add?appid=${this.currentAppid}&name=${this.currentAppName}&type=${l[e.tapIndex]}`)}})},async getAppList(){try{const{result:e}=await O.collection(S).get();e&&e.data&&e.data.length>0?this.appList=e.data.filter((e=>e.appid!==this.appid)):this.showModalToAppManager()}catch(e){-1===["TOKEN_INVALID_TOKEN_EXPIRED","TOKEN_INVALID_ANONYMOUS_USER"].indexOf(e.code)&&this.showModalToAppManager()}},showModalToAppManager(){let e=null,t=3;function a(){n({url:"/pages/system/app/list"}),clearInterval(e)}e=setInterval((()=>{--t<=0&&a()}),1e3),l({title:"请先添加应用",content:"即将跳转至应用管理……",showCancel:!1,confirmText:"立即跳转",success:e=>a()})},store_list_key(e){const t=e?e.filter((e=>e.enable)):[];return t.length?t.sort(((e,t)=>t.priority-e.priority)).map((e=>e.name)).join(","):"-"}}},[["render",function(e,t,a,i,n,s){const l=p,M=b(w("uni-icons"),I),V=x,$=v,S=A,O=b(w("uni-th"),C),R=b(w("uni-tr"),k),q=b(w("uni-td"),L),U=T,H=b(w("uni-data-picker"),z),K=b(w("uni-dateformat"),D),B=b(w("uni-table"),N),P=b(w("uni-pagination"),j),W=b(w("unicloud-db"),E);return o(),d(l,{class:"main"},{default:r((()=>[n.loaded?(o(),d(l,{key:0},{default:r((()=>[u(l,{class:"uni-header"},{default:r((()=>[u(l,{class:"uni-group"},{default:r((()=>[u(l,{class:"uni-sub-title"},{default:r((()=>[c("当前应用：")])),_:1}),u(l,{class:"uni-title app-list"},{default:r((()=>[u(V,{onChange:t[0]||(t[0]=e=>n.showAppIndex=e.detail.value),value:n.showAppIndex,range:s.appNameList},{default:r((()=>[u(l,{class:"uni-input",style:{"font-size":"14px"}},{default:r((()=>[c(h(s.appNameList[n.showAppIndex])+" ",1),u(M,{type:"bottom"})])),_:1})])),_:1},8,["value","range"])])),_:1})])),_:1}),u(l,{class:"uni-group"},{default:r((()=>[u($,{class:"uni-search",type:"text",modelValue:n.query,"onUpdate:modelValue":t[1]||(t[1]=e=>n.query=e),onConfirm:s.search,placeholder:"请输入搜索内容"},null,8,["modelValue","onConfirm"]),u(S,{class:"uni-button",type:"default",size:"mini",onClick:s.search},{default:r((()=>[c("搜索")])),_:1},8,["onClick"]),u(S,{class:"uni-button publish",type:"primary",size:"mini",onClick:s.publish},{default:r((()=>[c("发布新版")])),_:1},8,["onClick"]),u(S,{class:"uni-button",type:"warn",size:"mini",disabled:!n.selectedIndexs.length,onClick:s.delTable},{default:r((()=>[c("批量删除")])),_:1},8,["disabled","onClick"])])),_:1})])),_:1}),u(l,{class:"uni-container"},{default:r((()=>[u(W,{ref:"udb",collection:n.appVersionListDbName,field:"store_list,appid,contents,platform,type,version,min_uni_version,url,stable_publish,create_date,title,name",where:n.where,"page-data":"replace",orderby:n.orderby,getcount:!0,"page-size":n.options.pageSize,"page-current":n.options.pageCurrent,options:n.options},{default:r((({data:e,pagination:t,loading:a,error:i,options:n})=>[u(B,{style:{"overflow-y":"hidden"},loading:a,emptyText:i.message||"没有更多数据",border:"",stripe:"",type:"selection",onSelectionChange:s.selectionChange},{default:r((()=>[u(R,null,{default:r((()=>[u(O,{align:"center"},{default:r((()=>[c("AppID")])),_:1}),u(O,{align:"center"},{default:r((()=>[c("更新标题")])),_:1}),u(O,{align:"center"},{default:r((()=>[c("安装包类型")])),_:1}),u(O,{align:"center"},{default:r((()=>[c("平台")])),_:1}),u(O,{align:"center"},{default:r((()=>[c("已上架应用市场")])),_:1}),u(O,{align:"center"},{default:r((()=>[c("版本号")])),_:1}),u(O,{align:"center"},{default:r((()=>[c("安装包状态")])),_:1}),u(O,{align:"center"},{default:r((()=>[c("上传时间")])),_:1}),u(O,{align:"center"},{default:r((()=>[c("操作")])),_:1})])),_:1}),(o(!0),f(m,null,g(e,((e,t)=>(o(),d(R,{key:t,disabled:e.stable_publish},{default:r((()=>[u(q,{align:"center"},{default:r((()=>[c(h(e.appid),1)])),_:2},1024),u(q,{align:"center"},{default:r((()=>[c(h(e.title||"-"),1)])),_:2},1024),u(q,{align:"center"},{default:r((()=>[u(U,{style:_({padding:"5px 8px",backgroundColor:"wgt"===e.type?"#f0f9eb":"#ecf5ff",color:"wgt"===e.type?"#67c23a":"#409eff",border:"1px solid "+("wgt"===e.type?"#e1f3d8":"#d9ecff"),borderRadius:"4px"})},{default:r((()=>[c(h(n.type_valuetotext[e.type]),1)])),_:2},1032,["style"])])),_:2},1024),u(q,{align:"center"},{default:r((()=>[u(H,{localdata:n.platform_valuetotext,value:e.platform,border:!1,readonly:!0,split:","},null,8,["localdata","value"])])),_:2},1024),u(q,{align:"center"},{default:r((()=>[u(U,null,{default:r((()=>[c(h(s.store_list_key(e.store_list)),1)])),_:2},1024)])),_:2},1024),u(q,{align:"center"},{default:r((()=>[c(h(e.version),1)])),_:2},1024),u(q,{align:"center"},{default:r((()=>[c(h(1==e.stable_publish?"已上线":"已下线"),1)])),_:2},1024),u(q,{align:"center"},{default:r((()=>[u(K,{format:"yyyy-MM-dd hh:mm:ss",date:e.create_date,threshold:[0,0]},null,8,["date"])])),_:2},1024),u(q,{align:"center"},{default:r((()=>[u(S,{onClick:t=>s.navigateTo("./detail?id="+e._id,!1),class:"uni-button",size:"mini",type:"primary"},{default:r((()=>[c("详情")])),_:2},1032,["onClick"])])),_:2},1024)])),_:2},1032,["disabled"])))),128))])),_:2},1032,["loading","emptyText","onSelectionChange"]),u(l,{class:"uni-pagination-box"},{default:r((()=>[u(P,{"show-icon":"","page-size":t.size,modelValue:t.current,"onUpdate:modelValue":e=>t.current=e,total:t.count,onChange:s.onPageChanged},null,8,["page-size","modelValue","onUpdate:modelValue","total","onChange"])])),_:2},1024)])),_:1},8,["collection","where","orderby","page-size","page-current","options"])])),_:1})])),_:1})):(o(),d(l,{key:1,class:"page-loading",style:_(n.containerTop)},{default:r((()=>[y("i",{class:"uni-icon_toast uni-loading"})])),_:1},8,["style"]))])),_:1})}],["__scopeId","data-v-a55f3636"]]);export{H as default};
