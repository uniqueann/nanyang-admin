import{_ as e,D as t,z as a,A as i,n as s,B as n,y as l,o,c as r,w as p,i as d,a as u,d as c,t as h,e as f,r as g,F as m,C as _,E as y,f as b,g as w,G as x,I as A,q as v,H as I,h as C,j as k,k as L,p as T,l as N}from"./index-52dd6894.js";import{_ as D}from"./uni-data-picker.37409a89.js";import{_ as z}from"./uni-dateformat.611f3c3a.js";import{_ as j}from"./uni-pagination.229b82d6.js";import{_ as E}from"./unicloud-db.d767e55c.js";import{a as M,e as V,d as $,b as O}from"./utils.df25cf33.js";import"./uni-load-more.5c08c1b9.js";const S=t.database(),q=S.command,R=["name","title","stable_publish","type"];function U(e={}){return{create_env:q.neq("uni-stat"),...e}}const B=e({data:()=>({backButtonHover:!1,appVersionListDbName:M,currentAppid:"",currentAppName:"",query:"",where:"",orderby:"stable_publish desc,create_date desc",selectedIndexs:[],options:{pageSize:20,pageCurrent:1,...V},imageStyles:{width:64,height:64},loaded:!1,containerTop:{},appList:[],showAppIndex:0}),async onLoad({appid:e}){await this.getAppList(),this.appList.length?(this.loaded=!0,this.appList.forEach(((t,a)=>{(t.appid===e||$)&&(this.showAppIndex=a)})),this.setAppInfo(this.showAppIndex),this.where=U({appid:this.currentAppid})):this.showModalToAppManager()},computed:{...a("app",["appid"]),appNameList(){return this.appList.map((e=>e.name))}},watch:{showAppIndex(e){this.setAppInfo(e),this.where=U({appid:this.currentAppid})}},onReady(){this.containerTop.height=`${document.documentElement?document.documentElement.clientHeight:window.innerHeight}px`},methods:{setAppInfo(e){this.currentAppid=this.appList[e].appid,this.currentAppName=this.appList[e].name},navigateBack(){i()},getWhere(){const e=this.query.trim();if(!e)return"";const t=new RegExp(e,"i");return R.map((e=>t+".test("+e+")")).join(" || ")},search(){const e=this.getWhere(),t=e===this.where;this.where=e,this.where&&(this.where=`(${this.where}) && `),this.where+=`${new RegExp(this.currentAppid,"i")}.test(appid)`,t&&this.loadData()},loadData(e=!0){this.$refs.udb.loadData({clear:e})},onPageChanged(e){this.$refs.udb.loadData({current:e.current})},navigateTo(e,t){s({url:e,events:{refreshData:()=>{this.loadData(t)}}})},selectedItems(){var e=this.$refs.udb.dataList;return this.selectedIndexs.map((t=>e[t]._id))},delTable(){this.$refs.udb.remove(this.selectedItems())},selectionChange(e){this.selectedIndexs=e.detail.index},confirmDelete(e){this.$refs.udb.remove(e)},publish(e){const{top:t,left:a,width:i,height:s}=document.querySelector(".uni-button.publish").getBoundingClientRect(),l=Object.keys(this.options.type_valuetotext);n({itemList:Object.values(this.options.type_valuetotext),popover:{top:t+s,left:a,width:i},success:async e=>{this.navigateTo(`./add?appid=${this.currentAppid}&name=${this.currentAppName}&type=${l[e.tapIndex]}`)}})},async getAppList(){try{const{result:e}=await S.collection(O).get();e&&e.data&&e.data.length>0?this.appList=e.data.filter((e=>e.appid!==this.appid)):this.showModalToAppManager()}catch(e){-1===["TOKEN_INVALID_TOKEN_EXPIRED","TOKEN_INVALID_ANONYMOUS_USER"].indexOf(e.code)&&this.showModalToAppManager()}},showModalToAppManager(){let e=null,t=3;function a(){s({url:"/pages/system/app/list"}),clearInterval(e)}e=setInterval((()=>{--t<=0&&a()}),1e3),l({title:"请先添加应用",content:"即将跳转至应用管理……",showCancel:!1,confirmText:"立即跳转",success:e=>a()})},store_list_key(e){const t=e?e.filter((e=>e.enable)):[];return t.length?t.sort(((e,t)=>t.priority-e.priority)).map((e=>e.name)).join(","):"-"}}},[["render",function(e,t,a,i,s,n){const l=d,M=b(w("uni-icons"),I),V=x,$=A,O=v,S=b(w("uni-th"),C),q=b(w("uni-tr"),k),R=b(w("uni-td"),L),U=T,B=b(w("uni-data-picker"),D),H=b(w("uni-dateformat"),z),K=b(w("uni-table"),N),P=b(w("uni-pagination"),j),W=b(w("unicloud-db"),E);return o(),r(l,{class:"main"},{default:p((()=>[s.loaded?(o(),r(l,{key:0},{default:p((()=>[u(l,{class:"uni-header"},{default:p((()=>[u(l,{class:"uni-group"},{default:p((()=>[u(l,{class:"uni-sub-title"},{default:p((()=>[c("当前应用：")])),_:1}),u(l,{class:"uni-title app-list"},{default:p((()=>[u(V,{onChange:t[0]||(t[0]=e=>s.showAppIndex=e.detail.value),value:s.showAppIndex,range:n.appNameList},{default:p((()=>[u(l,{class:"uni-input",style:{"font-size":"14px"}},{default:p((()=>[c(h(n.appNameList[s.showAppIndex])+" ",1),u(M,{type:"bottom"})])),_:1})])),_:1},8,["value","range"])])),_:1})])),_:1}),u(l,{class:"uni-group"},{default:p((()=>[u($,{class:"uni-search",type:"text",modelValue:s.query,"onUpdate:modelValue":t[1]||(t[1]=e=>s.query=e),onConfirm:n.search,placeholder:"请输入搜索内容"},null,8,["modelValue","onConfirm"]),u(O,{class:"uni-button",type:"default",size:"mini",onClick:n.search},{default:p((()=>[c("搜索")])),_:1},8,["onClick"]),u(O,{class:"uni-button publish",type:"primary",size:"mini",onClick:n.publish},{default:p((()=>[c("发布新版")])),_:1},8,["onClick"]),u(O,{class:"uni-button",type:"warn",size:"mini",disabled:!s.selectedIndexs.length,onClick:n.delTable},{default:p((()=>[c("批量删除")])),_:1},8,["disabled","onClick"])])),_:1})])),_:1}),u(l,{class:"uni-container"},{default:p((()=>[u(W,{ref:"udb",collection:s.appVersionListDbName,field:"store_list,appid,contents,platform,type,version,min_uni_version,url,stable_publish,create_date,title,name",where:s.where,"page-data":"replace",orderby:s.orderby,getcount:!0,"page-size":s.options.pageSize,"page-current":s.options.pageCurrent,options:s.options},{default:p((({data:e,pagination:t,loading:a,error:i,options:s})=>[u(K,{style:{"overflow-y":"hidden"},loading:a,emptyText:i.message||"没有更多数据",border:"",stripe:"",type:"selection",onSelectionChange:n.selectionChange},{default:p((()=>[u(q,null,{default:p((()=>[u(S,{align:"center"},{default:p((()=>[c("AppID")])),_:1}),u(S,{align:"center"},{default:p((()=>[c("更新标题")])),_:1}),u(S,{align:"center"},{default:p((()=>[c("安装包类型")])),_:1}),u(S,{align:"center"},{default:p((()=>[c("平台")])),_:1}),u(S,{align:"center"},{default:p((()=>[c("已上架应用市场")])),_:1}),u(S,{align:"center"},{default:p((()=>[c("版本号")])),_:1}),u(S,{align:"center"},{default:p((()=>[c("安装包状态")])),_:1}),u(S,{align:"center"},{default:p((()=>[c("上传时间")])),_:1}),u(S,{align:"center"},{default:p((()=>[c("操作")])),_:1})])),_:1}),(o(!0),f(m,null,g(e,((e,t)=>(o(),r(q,{key:t,disabled:e.stable_publish},{default:p((()=>[u(R,{align:"center"},{default:p((()=>[c(h(e.appid),1)])),_:2},1024),u(R,{align:"center"},{default:p((()=>[c(h(e.title||"-"),1)])),_:2},1024),u(R,{align:"center"},{default:p((()=>[u(U,{style:_({padding:"5px 8px",backgroundColor:"wgt"===e.type?"#f0f9eb":"#ecf5ff",color:"wgt"===e.type?"#67c23a":"#409eff",border:"1px solid "+("wgt"===e.type?"#e1f3d8":"#d9ecff"),borderRadius:"4px"})},{default:p((()=>[c(h(s.type_valuetotext[e.type]),1)])),_:2},1032,["style"])])),_:2},1024),u(R,{align:"center"},{default:p((()=>[u(B,{localdata:s.platform_valuetotext,value:e.platform,border:!1,readonly:!0,split:","},null,8,["localdata","value"])])),_:2},1024),u(R,{align:"center"},{default:p((()=>[u(U,null,{default:p((()=>[c(h(n.store_list_key(e.store_list)),1)])),_:2},1024)])),_:2},1024),u(R,{align:"center"},{default:p((()=>[c(h(e.version),1)])),_:2},1024),u(R,{align:"center"},{default:p((()=>[c(h(1==e.stable_publish?"已上线":"已下线"),1)])),_:2},1024),u(R,{align:"center"},{default:p((()=>[u(H,{format:"yyyy-MM-dd hh:mm:ss",date:e.create_date,threshold:[0,0]},null,8,["date"])])),_:2},1024),u(R,{align:"center"},{default:p((()=>[u(O,{onClick:t=>n.navigateTo("./detail?id="+e._id,!1),class:"uni-button",size:"mini",type:"primary"},{default:p((()=>[c("详情")])),_:2},1032,["onClick"])])),_:2},1024)])),_:2},1032,["disabled"])))),128))])),_:2},1032,["loading","emptyText","onSelectionChange"]),u(l,{class:"uni-pagination-box"},{default:p((()=>[u(P,{"show-icon":"","page-size":t.size,modelValue:t.current,"onUpdate:modelValue":e=>t.current=e,total:t.count,onChange:n.onPageChanged},null,8,["page-size","modelValue","onUpdate:modelValue","total","onChange"])])),_:2},1024)])),_:1},8,["collection","where","orderby","page-size","page-current","options"])])),_:1})])),_:1})):(o(),r(l,{key:1,class:"page-loading",style:_(s.containerTop)},{default:p((()=>[y("i",{class:"uni-icon_toast uni-loading"})])),_:1},8,["style"]))])),_:1})}],["__scopeId","data-v-b3180fa5"]]);export{B as default};
